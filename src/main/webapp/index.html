<!DOCTYPE html>
<html lang="pt-br">
    <!--References: http://bl.ocks.org/mbostock/4062045-->
    <head>
        <meta charset="utf-8">
        <title>Caratheodory Number</title>
        <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
        <link  href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-resource.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular-route.min.js"></script>
        <script src="assets/js/filesaver.min.js"></script>

        <style>
            .node {
                fill: #000;
                cursor: crosshair;
            }

            .node_selected {
                fill: #ff7f0e;
                stroke: #ff7f0e;
            }

            .drag_line {
                stroke: #999;
                stroke-width: 5;
                pointer-events: none;
            }

            .drag_line_hidden {
                stroke: #999;
                stroke-width: 0;
                pointer-events: none;
            }

            .link {
                stroke: #999;
                stroke-width: 5;
                cursor: crosshair;
            }

            .link_selected {
                stroke: #ff7f0e;
            }

            .node title, .node text {
                pointer-events: none;
                font: 10px sans-serif;
            }

            samp {
                overflow: auto;
                word-wrap: normal;
                white-space: pre;
            }
        </style>
    </head>
    <body>
        <div class="jumbotron">
            <div class="container">
                <h1>Caratheodory Number</h1>
                <p>In P3-Convexity</p>
            </div>
        </div>

        <div class="container"
             ng-app="appCaratheodroyNumber" 
             ng-controller="caratheodoryNumberController">
            <div class="row">
                <div class="col-md-3">

                    <fieldset>
                        <legend>Generate</legend>
                        <div class="form-group">
                            <label for="nvertices">Vertex count</label>
                            <input type="text" class="form-control" 
                                   id="nvertices"  min="1"
                                   ng-model="nvertices"
                                   name="nvertices" autofocus required>
                        </div>
                        <div class="form-group">
                            <label for="minDegree">Vertex degree (suggestion)</label>
                            <input type="number"
                                   class="form-control"
                                   ng-model="minDegree" min="1"
                                   id="minDegree" name="minDegree" 
                                   placeholder="1">
                            <input type="text"
                                   class="form-control"
                                   ng-model="maxDegree" min="1.1"
                                   id="maxDegree" name="maxDegree" 
                                   placeholder="5">
                        </div>
                        <div class="checkbox">
                            <label>
                                <input type="checkbox" value="sim"                                        
                                       disabled name="spam" checked>
                                Connected
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="typeG">Type</label>
                            <select type="select" class="form-control"
                                    ng-model="typeGraph"
                                    id="typeG" name="minDegree" 
                                    placeholder="1">
                                <option value=""></option>
                                <option ng-repeat="x in generators" value="{{x.key}}">{{x.value}}</option>
                            </select>
                        </div>
                        <div class="form-group pull-right">
                            <button ng-click="generateGraph();" 
                                    class="btn btn-primary btn-sm">
                                <span class="glyphicon glyphicon-repeat"></span>
                                Generate graph
                            </button>
                        </div>
                    </fieldset>
                    <fieldset>
                        <legend>Graph</legend>
                        <div class="form-group">
                            <label>Vertices({{graph.vertexCount}})</label>
                            <input class="form-control" disabled
                                   ng-model="graph.vertices" />
                        </div>
                        <div class="form-group">
                            <label>Edges({{graph.edgeCount}})</label>
                            <input class="form-control" disabled
                                   value="{{graph.pairs}}" />
                        </div>

                        <div class="form-group">
                            <input name="file" id="file" 
                                   class="form-control" type="file"
                                   ng-file-select="onFileSelect($files)">
                        </div>
                        <div class="form-group pull-right">
                            <button class="btn btn-primary btn-sm" 
                                    ng-click="downloadGraph();">
                                <span class="glyphicon glyphicon-circle-arrow-down"></span>
                                Download (json)
                            </button>
                            <button ng-click="uploadedFile()" class="btn btn-primary btn-sm">
                                <span class="glyphicon glyphicon-circle-arrow-up"></span>
                                Upload (json)
                            </button>
                        </div>
                    </fieldset>

                    <fieldset>
                        <legend>Analyze</legend>
                        <div class="form-group">
                            <label>Caratheodroy number(c)</label>
                            <input type="number" class="form-control" 
                                   ng-model="caratheodory.number" 
                                   disabled readonly>
                        </div>
                        <div class="form-group">
                            <label>Caratheodroy set(S)</label>
                            <input type="text"
                                   class="form-control"
                                   ng-model="setstr">
                        </div>

                        <div class="form-group">
                            <label>Convex hull(H(S))</label>
                            <input type="text"
                                   class="form-control"
                                   ng-model="caratheodory.hs" 
                                   disabled readonly>
                        </div>

                        <div class="form-group">
                            <label>∂H(S)=H(S)\⋃p∈SH(S\{p})</label>
                            <input type="text"
                                   class="form-control"
                                   ng-model="caratheodory.phs" 
                                   disabled readonly>
                        </div>
                        <div class="form-group">
                            <label>Time(s)</label>
                            <input type="text"
                                   class="form-control"
                                   ng-model="caratheodory.tms" 
                                   disabled readonly>
                        </div>

                        <div class="form-group">
                            <label for="typeG">Operation</label>
                            <select type="select" class="form-control"
                                    ng-model="operation"
                                    id="typeOperation"
                                    placeholder="1">
                                <option ng-repeat="x in operations" value="{{x.type}}">{{x.value}}</option>
                            </select>
                        </div>

                        <div class="form-group pull-right">
                            <button ng-click="executeOperation();" 
                                    class="btn btn-primary">
                                <span class="glyphicon glyphicon-certificate"></span>
                                Execute
                            </button>
                        </div>
                    </fieldset>
                </div>
                <div class="col-md-9">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h2>Graph</h2>
                        </div>

                        <div class="panel-body">
                            <div id="grafo" class="form-group" style="height: 600px;">

                            </div>
                        </div>
                        <div id="spinner" ng-show="processing">
                            <img src="assets/img/spinner.gif" alt="">
                        </div>
                        <div class="well well-sm pre-scrollable">
                            <samp>[INFO] Scanning for projects...</samp>
                            <samp>[INFO]                                                                         </samp>
                            <samp>[INFO] ------------------------------------------------------------------------</samp>
                            <samp>[INFO] Building graph-hull-number 1.0-SNAPSHOT</samp>
                            <samp>[INFO] ------------------------------------------------------------------------</samp>
                            <samp>[INFO] --- maven-war-plugin:2.3:war (default-war) @ graph-hull-number ---</samp>
                            <samp>[INFO] Packaging webapp</samp>
                            <samp>[INFO] Assembling webapp [graph-hull-number] in [/tmp/build_8c281c1be9f343ff72123199491afaf1/braully-graph-hull-number-d19af07/target/graph-hull-number-1.0-SNAPSHOT]</samp>
                            <samp>[INFO] Processing war project</samp>
                            <samp>[INFO] Copying webapp resources [/tmp/build_8c281c1be9f343ff72123199491afaf1/braully-graph-hull-number-d19af07/src/main/webapp]</samp>
                            <samp>[INFO] Webapp assembled in [68 msecs]</samp>
                            <samp>[INFO] Building war: /tmp/build_8c281c1be9f343ff72123199491afaf1/braully-graph-hull-number-d19af07/target/graph-hull-number-1.0-SNAPSHOT.war</samp>
                            <samp>[INFO] </samp>
                            <samp>[INFO] --- maven-install-plugin:2.4:install (default-install) @ graph-hull-number ---</samp>
                            <samp>[INFO] Installing /tmp/build_8c281c1be9f343ff72123199491afaf1/braully-graph-hull-number-d19af07/target/graph-hull-number-1.0-SNAPSHOT.war to /app/tmp/cache/.m2/repository/com/github/braully/graph-hull-number/1.0-SNAPSHOT/graph-hull-number-1.0-SNAPSHOT.war</samp>
                            <samp>[INFO] Installing /tmp/build_8c281c1be9f343ff72123199491afaf1/braully-graph-hull-number-d19af07/pom.xml to /app/tmp/cache/.m2/repository/com/github/braully/graph-hull-number/1.0-SNAPSHOT/graph-hull-number-1.0-SNAPSHOT.pom</samp>
                            <samp>[INFO] ------------------------------------------------------------------------</samp>
                            <samp>[INFO] BUILD SUCCESS</samp>
                            <samp>[INFO] ------------------------------------------------------------------------</samp>
                            <samp>[INFO] Total time: 4.218 s</samp>
                            <samp>[INFO] Finished at: 2016-10-07T17:23:49+00:00</samp>
                            <samp>[INFO] Final Memory: 23M/167M</samp>
                            <samp>[INFO] ------------------------------------------------------------------------</samp>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            var app = angular.module('appCaratheodroyNumber', []);
            app.controller('caratheodoryNumberController', function ($scope, $http) {
                $scope.nvertices = 5;
                $scope.minDegree = 1;
                $scope.maxDegree = 2.0;
                $scope.generators = null;
                $scope.operations = null;
                $scope.operation = null;
                $scope.processing = true;
                $scope.typeGraph = 'random';
                $scope.graph = null;
                $scope.file = null;
                $scope.setstr = null;
                $scope.caratheodory = {number: [], set: [], aux: [], hs: [], phs: []};



                $scope.calcCaratheodroyNumberGraph = function () {
                    $http.post('rest/graph/caratheodory', $scope.graph).success(function (caratheodorydata) {
                        $scope.caratheodory = caratheodorydata;
                        $scope.setstr = $scope.caratheodory.set.toString();
                    });
                };

                $scope.calcCaratheodroyNumberGraphParallel = function () {
                    $http.post('rest/graph/caratheodory-parallel', $scope.graph).success(function (caratheodorydata) {
                        $scope.caratheodory = caratheodorydata;
                        $scope.setstr = $scope.caratheodory.set.toString();
                    });
                };

                $scope.checkSet = function () {
                    $scope.graph.set = $scope.setstr.split(',').map(Number);
                    $http.post('rest/graph/checkset', $scope.graph).success(function (caratheodorydata) {
                        $scope.caratheodory = caratheodorydata;
                    });
                };

                $scope.downloadGraph = function () {
                    var filename = 'graph-' + $scope.nvertices + '-' + $scope.minDegree + '-' + $scope.maxDegree + '.json';
                    var textContent = JSON.stringify($scope.graph, null, '\t');
                    var blob = new Blob([textContent], {type: "text/plain;charset=utf-8"});
                    saveAs(blob, filename);
                };

                $scope.uploadedFile = function () {
                    if (!$scope.file) {
                        window.alert('File invalid');
                        return;
                    }
                    var fr = new FileReader();
                    fr.onload = function (e) {
                        var graph = JSON.parse(e.target.result);
                        if (!graph || !graph.vertices || !graph.pairs) {
                            window.alert('File format invalid');
                        } else {
                            $scope.graph = graph;
                            $scope.updateGraph();
                        }
                    };
                    fr.readAsText($scope.file);
                };
                $scope.updateGraph = function () {
                    var graph = $scope.graph;
                    var width = $("#grafo").width();
                    var height = $("#grafo").height();
                    $("#grafo").html('');
                    var color = d3.scale.category20();
                    var force = d3.layout.force()
                            .charge(-120)
                            .linkDistance(70)
                            .size([width, height]);
                    var svg = d3.select("#grafo")
                            .append("svg")
                            .attr("width", width)
                            .attr("height", height);
                    var vertex = graph.vertices.map(function (d) {
                        return {"name": d, "group": 1};
                    });
                    var edges = graph.pairs.map(function (d) {
                        return {"source": d[0], "target": d[1], "value": 2, "origin": d};
                    });
                    force.nodes(vertex).links(edges).start();
                    var link = svg.selectAll(".link")
                            .data(edges)
                            .enter().append("line")
                            .attr("class", "link")
                            .style("stroke-width", function (d) {
                                return Math.sqrt(d.value);
                            });
                    var nodes = svg.selectAll(".node")
                            .data(vertex)
                            .enter().append("g")
                            .attr("class", "node")
                            .call(force.drag);
                    nodes.append("circle")
                            .attr("class", "node")
                            .attr("r", 5)
                            //                                .attr("x", -8)
                            //                                .attr("y", -8)
                            .style("fill", function (d) {
                                return color(d.group);
                            }).call(force.drag);
                    nodes.append("text").attr("dx", 6)
                            .attr("dy", ".35em")
                            .text(function (d) {
                                return d.name;
                            });
                    force.on("tick", function () {
                        link.attr("x1", function (d) {
                            return d.source.x;
                        }).attr("y1", function (d) {
                            return d.source.y;
                        }).attr("x2", function (d) {
                            return d.target.x;
                        }).attr("y2", function (d) {
                            return d.target.y;
                        });
                        nodes.attr("transform", function (d) {
                            return "translate(" + d.x + "," + d.y + ")";
                        }).attr("cx", function (d) {
                            return d.x;
                        }).attr("cy", function (d) {
                            return d.y;
                        });
                    });
                }
                ;
                $scope.generateGraph = function () {
                    $http.get('rest/graph/generate-graph', {
                        params: {
                            nvertices: $scope.nvertices,
                            minDegree: $scope.minDegree,
                            maxDegree: $scope.maxDegree,
                            typeGraph: $scope.typeGraph
                        }
                    }).success(function (graph) {
                        $scope.graph = graph;
                        $scope.updateGraph();
                    });
                };

                $scope.executeOperation = function () {
                    if ($scope.setstr)
                        $scope.graph.set = $scope.setstr.split(',').map(Number);
                    $scope.graph.operation = $scope.operation;
                    $http.post('rest/graph/operation', $scope.graph).success(function (caratheodorydata) {
                        $scope.caratheodory = caratheodorydata;
                        $scope.setstr = $scope.caratheodory.set.toString();
                    });
                };

                $http.get('rest/graph/list-graph-generator').success(function (gen) {
                    $scope.generators = gen;
                });

                $http.get('rest/graph/list-graph-operation').success(function (ops) {
                    $scope.operations = ops;
                });

                $scope.generateGraph();
            });
            app.directive("ngFileSelect", function () {
                return {
                    link: function ($scope, el) {
                        el.bind("change", function (e) {
                            var file = (e.srcElement || e.target).files[0];
                            $scope.file = file;
                        });
                    }
                };
            });
        </script>
    </body>
</html>